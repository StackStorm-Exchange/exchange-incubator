name: Bootstrack Pack from PR

on:
#  pull_request_target:
#    types: [labeled]
#  pull_request_review:
#    types: [submitted]
  issue_comment:
    types: created

# need vars:
#   env.PACK_ORG: StackStorm-Exchange
#   env.PACK_REPO_PREFIX: stackstorm
#   env.PACK_REPO_TEMPLATE: StackStorm-Exchange/exchange-template
#   env.TSC_TEAM: TSC
#
# need secrets:
#   env.GH_TOKEN: admin bot PAT w/ scopes public_repo, workflow, write:org
#   env.SLACK_WEBHOOK_URL

jobs:
  tsc_membership_check:
    # "!bootstrap pack" comment on pull requests
    if: github.event.comment.body == '!bootstrap pack' && github.event.issue.pull_request

    runs-on: ubuntu-latest
    steps:
      - name: Validate commentor permissions
        # must be a TSC member

  ready_to_merge_check:
    needs: [tsc_membership_check]
    runs-on: ubuntu-latest
    steps:
      - name: Make sure incubator PR is approved
      - name: Make sure CI workflow is passing for PR

      - name: Publish status in incubator PR comment # and/or label

  extract_pack_details:
    needs: [tsc_membership_check, ready_to_merge_check]
    runs-on: ubuntu-latest
    steps:
      - name: Extract Pack Details
        id: pack-details
        # TODO: switch from @gha to @master
        uses: StackStorm-Exchange/ci/.github/actions/extract-pack-meta.yaml@gha
        with:
          pack-directory: incubator
          repository: ${{ github.repository }}
          # expects an issue_comment event
          ref: pull/${{ github.event.issue.number }}/head
          fetch-depth: 0
    outputs:
      pack_name: ${{ steps.pack-details.outputs.pack_name }}
      pack_ref: ${{ steps.pack-details.outputs.pack_ref }}
      pack_description: ${{ steps.pack-details.outputs.pack_description }}
      pack_path: ${{ steps.pack-details.outputs.pack_path }}
      in_submodule: ${{ steps.pack-details.outputs.in_submodule }}
      in_subdir: ${{ steps.pack-details.outputs.in_subdir }}

  bootstrap_pack_repo:
    needs: [extract_pack_details]
    name: New Pack # / Bootstrap Repo
    # TODO: switch from @gha to @master
    uses: StackStorm-Exchange/ci/.github/workflows/pack-bootstrap_repo.yaml@gha
    with:
      # secrets
      admin_token: "" # TODO: admin PAT with scopes: public_repo, workflows, org:write
      slack_webhook_url: "" # TODO
      # TODO: validate that this || works as expected
      pack_name: ${{ jobs.extract_pack_details.outputs.pack_ref || jobs.extract_pack_details.outputs.pack_name }}
      pack_description: ${{ jobs.extract_pack_details.outputs.pack_description }}

  # based on https://github.com/StackStorm-Exchange/exchange-incubator/issues/7#issuecomment-923614663
  create_pack_pr_from_subdirectory:
    needs: [extract_pack_details, bootstrap_pack]
    if: jobs.extract_pack_details.outputs.in_submodule == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout pack repo
        uses: actions/checkout@v2
        with:
          repository: ${{ jobs.bootstrap_pack_repo.outputs.pack_repo }}
          path: pack
          fetch-depth: 0

      - name: Checkout incubator
        uses: actions/checkout@v2
        with:
          path: incubator
          fetch-depth: 0

      - name: Checkout Incubator PR
        working-directory: incubator
        shell: bash
        run: |
          git fetch origin pull/${{ github.event.issue.number }}/head:pr
          git checkout pr

      - name: Add incubator as git remote
        working-directory: pack
        shell: bash
        run: |
          git remote add source ../incubator
          git fetch source

      - name: Create branch for initial pack content
      - name: Copy Incubator PR contents
      - name: Commit and Push

      - name: Create initial content PR on pack repo (subdirectory)

      - name: Publish status in incubator PR comment # and/or label

  # based on https://github.com/StackStorm-Exchange/exchange-incubator/issues/7#issuecomment-281247786
  create_pack_pr_from_submodule:
    needs: [extract_pack_details, bootstrap_pack]
    if: jobs.extract_pack_details.outputs.in_submodule == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout pack repo
        uses: actions/checkout@v2
        with:
          repository: ${{ jobs.bootstrap_pack_repo.outputs.pack_repo }}
          path: pack
          fetch-depth: 0

      - name: Checkout incubator
        uses: actions/checkout@v2
        with:
          path: incubator
          fetch-depth: 0

      - name: Checkout Incubator PR and Submodules
        shell: bash
        run: |
          git fetch origin pull/${{ github.event.issue.number }}/head:pr
          git checkout pr
          git submodule init
          git submodule update --remote

      - name: Add git remote for source repo in incubator submodule
        working-directory: pack
        shell: bash
        run: |
          git remote add source ${{ jobs.extract_pack_details.outputs.pack_path }}
          git fetch source

      - name: Pull source history into pack repo
        # --allow-unrelated-histories
        # fix merge conflicts by preferring exchange-provided files
        # (which should be a minimal required set of files)

      - name: Create initial content PR on pack repo

      - name: Publish status in incubator PR comment # and/or label
